{"version":3,"file":"title.cjs","sources":["../../../src/utils/title.ts"],"sourcesContent":["import { z } from 'zod';\nimport { ChatPromptTemplate } from '@langchain/core/prompts';\nimport { RunnableLambda, RunnableSequence } from '@langchain/core/runnables';\nimport type { Runnable, RunnableConfig } from '@langchain/core/runnables';\nimport type { AIMessage } from '@langchain/core/messages';\nimport type * as t from '@/types';\nimport { ContentTypes } from '@/common';\n\nconst defaultTitlePrompt = `Analyze this conversation and provide:\n1. The detected language of the conversation\n2. A concise title in the detected language (5 words or less, no punctuation or quotation)\n\n{convo}`;\n\nconst titleSchema = z.object({\n  title: z\n    .string()\n    .describe(\n      'A concise title for the conversation in 5 words or less, without punctuation or quotation'\n    ),\n});\n\nconst combinedSchema = z.object({\n  language: z.string().describe('The detected language of the conversation'),\n  title: z\n    .string()\n    .describe(\n      'A concise title for the conversation in 5 words or less, without punctuation or quotation'\n    ),\n});\n\nexport const createTitleRunnable = async (\n  model: t.ChatModelInstance,\n  _titlePrompt?: string\n): Promise<Runnable> => {\n  // Disabled since this works fine\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  /* @ts-ignore */\n  const titleLLM = model.withStructuredOutput(titleSchema);\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  /* @ts-ignore */\n  const combinedLLM = model.withStructuredOutput(combinedSchema);\n\n  const titlePrompt = ChatPromptTemplate.fromTemplate(\n    _titlePrompt ?? defaultTitlePrompt\n  ).withConfig({ runName: 'TitlePrompt' });\n\n  const titleOnlyInnerChain = RunnableSequence.from([titlePrompt, titleLLM]);\n  const combinedInnerChain = RunnableSequence.from([titlePrompt, combinedLLM]);\n\n  /** Wrap titleOnlyChain in RunnableLambda to create parent span */\n  const titleOnlyChain = new RunnableLambda({\n    func: async (\n      input: { convo: string },\n      config?: Partial<RunnableConfig>\n    ): Promise<{ title: string }> => {\n      return await titleOnlyInnerChain.invoke(input, config);\n    },\n  }).withConfig({ runName: 'TitleOnlyChain' });\n\n  /** Wrap combinedChain in RunnableLambda to create parent span */\n  const combinedChain = new RunnableLambda({\n    func: async (\n      input: { convo: string },\n      config?: Partial<RunnableConfig>\n    ): Promise<{ language: string; title: string }> => {\n      return await combinedInnerChain.invoke(input, config);\n    },\n  }).withConfig({ runName: 'TitleLanguageChain' });\n\n  /** Runnable to add default values if needed */\n  const addDefaults = new RunnableLambda({\n    func: (\n      result: { language: string; title: string } | undefined\n    ): { language: string; title: string } => ({\n      language: result?.language ?? 'English',\n      title: result?.title ?? '',\n    }),\n  }).withConfig({ runName: 'AddDefaults' });\n\n  const combinedChainInner = RunnableSequence.from([\n    combinedChain,\n    addDefaults,\n  ]);\n\n  /** Wrap combinedChainWithDefaults in RunnableLambda to create parent span */\n  const combinedChainWithDefaults = new RunnableLambda({\n    func: async (\n      input: { convo: string },\n      config?: Partial<RunnableConfig>\n    ): Promise<{ language: string; title: string }> => {\n      return await combinedChainInner.invoke(input, config);\n    },\n  }).withConfig({ runName: 'CombinedChainWithDefaults' });\n\n  return new RunnableLambda({\n    func: async (\n      input: {\n        convo: string;\n        inputText: string;\n        skipLanguage: boolean;\n      },\n      config?: Partial<RunnableConfig>\n    ): Promise<{ language: string; title: string } | { title: string }> => {\n      const invokeInput = { convo: input.convo };\n\n      if (input.skipLanguage) {\n        return (await titleOnlyChain.invoke(invokeInput, config)) as {\n          title: string;\n        };\n      }\n\n      return await combinedChainWithDefaults.invoke(invokeInput, config);\n    },\n  }).withConfig({ runName: 'TitleGenerator' });\n};\n\nconst defaultCompletionPrompt = `Provide a concise, 5-word-or-less title for the conversation, using title case conventions. Only return the title itself.\n\nConversation:\n{convo}`;\n\nexport const createCompletionTitleRunnable = async (\n  model: t.ChatModelInstance,\n  titlePrompt?: string\n): Promise<Runnable> => {\n  const completionPrompt = ChatPromptTemplate.fromTemplate(\n    titlePrompt ?? defaultCompletionPrompt\n  ).withConfig({ runName: 'CompletionTitlePrompt' });\n\n  /** Runnable to extract content from model response */\n  const extractContent = new RunnableLambda({\n    func: (response: AIMessage): { title: string } => {\n      let content = '';\n      if (typeof response.content === 'string') {\n        content = response.content;\n      } else if (Array.isArray(response.content)) {\n        content = response.content\n          .filter(\n            (part): part is { type: ContentTypes.TEXT; text: string } =>\n              part.type === ContentTypes.TEXT\n          )\n          .map((part) => part.text)\n          .join('');\n      }\n      return { title: content.trim() };\n    },\n  }).withConfig({ runName: 'ExtractTitle' });\n\n  const innerChain = RunnableSequence.from([\n    completionPrompt,\n    model,\n    extractContent,\n  ]);\n\n  /** Wrap in RunnableLambda to create a parent span for LangFuse */\n  return new RunnableLambda({\n    func: async (\n      input: { convo: string },\n      config?: Partial<RunnableConfig>\n    ): Promise<{ title: string }> => {\n      return await innerChain.invoke(input, config);\n    },\n  }).withConfig({ runName: 'CompletionTitleChain' });\n};\n"],"names":["z","ChatPromptTemplate","RunnableSequence","RunnableLambda","ContentTypes"],"mappings":"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"}