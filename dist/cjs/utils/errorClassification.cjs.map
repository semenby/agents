{"version":3,"file":"errorClassification.cjs","sources":["../../../src/utils/errorClassification.ts"],"sourcesContent":["// src/utils/errorClassification.ts\nimport type { ClassifiedError, ErrorClassification } from '../types/errors';\n\nconst TIMEOUT_PATTERNS = [\n  /timeout/i,\n  /timed out/i,\n  /ETIMEDOUT/i,\n  /ECONNRESET/i,\n  /socket hang up/i,\n];\n\nconst RATE_LIMIT_PATTERNS = [\n  /rate.?limit/i,\n  /too many requests/i,\n  /429/,\n  /quota exceeded/i,\n  /capacity/i,\n];\n\nconst SERVER_ERROR_PATTERNS = [\n  /500/,\n  /502/,\n  /503/,\n  /504/,\n  /internal server error/i,\n  /bad gateway/i,\n  /service unavailable/i,\n];\n\nconst UNAVAILABLE_PATTERNS = [\n  /ENOTFOUND/i,\n  /ECONNREFUSED/i,\n  /getaddrinfo/i,\n  /network/i,\n  /unreachable/i,\n];\n\nconst AUTH_PATTERNS = [\n  /401/,\n  /403/,\n  /unauthorized/i,\n  /forbidden/i,\n  /invalid.*key/i,\n  /authentication/i,\n  /api.?key/i,\n];\n\nconst NOT_FOUND_PATTERNS = [\n  /404/,\n  /not found/i,\n  /does not exist/i,\n  /model.*disabled/i,\n];\n\nconst BAD_REQUEST_PATTERNS = [/400/, /malformed/i, /bad request/i];\n\n/**\n * Classifies an error to determine if fallback should be attempted.\n * @param error - The error to classify\n * @returns Classification result with type, message, and retryable flag\n */\nexport function classifyError(error: unknown): ClassifiedError {\n  const message = error instanceof Error ? error.message : String(error);\n  const statusCode =\n    (error as { status?: number; statusCode?: number }).status ??\n    (error as { status?: number; statusCode?: number }).statusCode;\n\n  // Check status code first (most reliable)\n  if (statusCode) {\n    if (statusCode === 429) {\n      return { type: 'rateLimit', message, retryable: true };\n    }\n    if (statusCode === 401 || statusCode === 403) {\n      return { type: 'auth', message, retryable: false };\n    }\n    if (statusCode === 404) {\n      return { type: 'notFound', message, retryable: true };\n    }\n    if (statusCode === 400) {\n      return { type: 'badRequest', message, retryable: false };\n    }\n    if (statusCode >= 500 && statusCode < 600) {\n      return { type: 'serverError', message, retryable: true };\n    }\n  }\n\n  // Check message patterns\n  if (TIMEOUT_PATTERNS.some((p) => p.test(message))) {\n    return { type: 'timeout', message, retryable: true };\n  }\n  if (RATE_LIMIT_PATTERNS.some((p) => p.test(message))) {\n    return { type: 'rateLimit', message, retryable: true };\n  }\n  if (AUTH_PATTERNS.some((p) => p.test(message))) {\n    return { type: 'auth', message, retryable: false };\n  }\n  if (NOT_FOUND_PATTERNS.some((p) => p.test(message))) {\n    return { type: 'notFound', message, retryable: true };\n  }\n  if (BAD_REQUEST_PATTERNS.some((p) => p.test(message))) {\n    return { type: 'badRequest', message, retryable: false };\n  }\n  if (SERVER_ERROR_PATTERNS.some((p) => p.test(message))) {\n    return { type: 'serverError', message, retryable: true };\n  }\n  if (UNAVAILABLE_PATTERNS.some((p) => p.test(message))) {\n    return { type: 'unavailable', message, retryable: true };\n  }\n\n  // Default: unknown but retryable (conservative approach)\n  return { type: 'unknown', message, retryable: true };\n}\n\n/**\n * Default error types that should trigger fallback\n */\nconst DEFAULT_FALLBACK_ON: ErrorClassification[] = [\n  'timeout',\n  'rateLimit',\n  'serverError',\n  'unavailable',\n  'notFound',\n];\n\n/**\n * Determines if the error type should trigger a fallback attempt.\n * @param errorType - The classified error type\n * @param fallbackOn - Array of error types that should trigger fallback (defaults to recoverable errors)\n * @returns True if fallback should be attempted\n */\nexport function shouldTriggerFallback(\n  errorType: ErrorClassification,\n  fallbackOn: ErrorClassification[] = DEFAULT_FALLBACK_ON\n): boolean {\n  return fallbackOn.includes(errorType);\n}\n"],"names":[],"mappings":"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"}