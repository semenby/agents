{"version":3,"file":"common.cjs","sources":["../../../../../src/llm/google/utils/common.ts"],"sourcesContent":["import {\n  POSSIBLE_ROLES,\n  type Part,\n  type Content,\n  type TextPart,\n  type FileDataPart,\n  type InlineDataPart,\n  type FunctionCallPart,\n  type GenerateContentCandidate,\n  type EnhancedGenerateContentResponse,\n  type FunctionDeclaration as GenerativeAIFunctionDeclaration,\n  type FunctionDeclarationsTool as GoogleGenerativeAIFunctionDeclarationsTool,\n} from '@google/generative-ai';\nimport {\n  AIMessage,\n  AIMessageChunk,\n  BaseMessage,\n  ChatMessage,\n  ToolMessage,\n  ToolMessageChunk,\n  MessageContent,\n  MessageContentComplex,\n  UsageMetadata,\n  isAIMessage,\n  isBaseMessage,\n  isToolMessage,\n  StandardContentBlockConverter,\n  parseBase64DataUrl,\n  convertToProviderContentBlock,\n  isDataContentBlock,\n} from '@langchain/core/messages';\nimport { ChatGenerationChunk } from '@langchain/core/outputs';\nimport type { ChatGeneration, ChatResult } from '@langchain/core/outputs';\nimport { isLangChainTool } from '@langchain/core/utils/function_calling';\nimport { isOpenAITool } from '@langchain/core/language_models/base';\nimport { ToolCallChunk } from '@langchain/core/messages/tool';\nimport { v4 as uuidv4 } from 'uuid';\nimport {\n  jsonSchemaToGeminiParameters,\n  schemaToGenerativeAIParameters,\n} from './zod_to_genai_parameters';\nimport { GoogleGenerativeAIToolType } from '../types';\n\nexport const _FUNCTION_CALL_THOUGHT_SIGNATURES_MAP_KEY =\n  '__gemini_function_call_thought_signatures__';\n\nconst DUMMY_SIGNATURE =\n  'ErYCCrMCAdHtim9kOoOkrPiCNVsmlpMIKd7ZMxgiFbVQOkgp7nlLcDMzVsZwIzvuT7nQROivoXA72ccC2lSDvR0Gh7dkWaGuj7ctv6t7ZceHnecx0QYa+ix8tYpRfjhyWozQ49lWiws6+YGjCt10KRTyWsZ2h6O7iHTYJwKIRwGUHRKy/qK/6kFxJm5ML00gLq4D8s5Z6DBpp2ZlR+uF4G8jJgeWQgyHWVdx2wGYElaceVAc66tZdPQRdOHpWtgYSI1YdaXgVI8KHY3/EfNc2YqqMIulvkDBAnuMhkAjV9xmBa54Tq+ih3Im4+r3DzqhGqYdsSkhS0kZMwte4Hjs65dZzCw9lANxIqYi1DJ639WNPYihp/DCJCos7o+/EeSPJaio5sgWDyUnMGkY1atsJZ+m7pj7DD5tvQ==';\n\n/**\n * Executes a function immediately and returns its result.\n * Functional utility similar to an Immediately Invoked Function Expression (IIFE).\n * @param fn The function to execute.\n * @returns The result of invoking fn.\n */\nexport const iife = <T>(fn: () => T): T => fn();\n\nexport function getMessageAuthor(message: BaseMessage): string {\n  const type = message._getType();\n  if (ChatMessage.isInstance(message)) {\n    return message.role;\n  }\n  if (type === 'tool') {\n    return type;\n  }\n  return message.name ?? type;\n}\n\n/**\n * Maps a message type to a Google Generative AI chat author.\n * @param message The message to map.\n * @param model The model to use for mapping.\n * @returns The message type mapped to a Google Generative AI chat author.\n */\nexport function convertAuthorToRole(\n  author: string\n): (typeof POSSIBLE_ROLES)[number] {\n  switch (author) {\n  /**\n     *  Note: Gemini currently is not supporting system messages\n     *  we will convert them to human messages and merge with following\n     * */\n  case 'supervisor':\n  case 'ai':\n  case 'model': // getMessageAuthor returns message.name. code ex.: return message.name ?? type;\n    return 'model';\n  case 'system':\n    return 'system';\n  case 'human':\n    return 'user';\n  case 'tool':\n  case 'function':\n    return 'function';\n  default:\n    throw new Error(`Unknown / unsupported author: ${author}`);\n  }\n}\n\nfunction messageContentMedia(content: MessageContentComplex): Part {\n  if ('mimeType' in content && 'data' in content) {\n    return {\n      inlineData: {\n        mimeType: content.mimeType,\n        data: content.data,\n      },\n    };\n  }\n  if ('mimeType' in content && 'fileUri' in content) {\n    return {\n      fileData: {\n        mimeType: content.mimeType,\n        fileUri: content.fileUri,\n      },\n    };\n  }\n\n  throw new Error('Invalid media content');\n}\n\nfunction inferToolNameFromPreviousMessages(\n  message: ToolMessage | ToolMessageChunk,\n  previousMessages: BaseMessage[]\n): string | undefined {\n  return previousMessages\n    .map((msg) => {\n      if (isAIMessage(msg)) {\n        return msg.tool_calls ?? [];\n      }\n      return [];\n    })\n    .flat()\n    .find((toolCall) => {\n      return toolCall.id === message.tool_call_id;\n    })?.name;\n}\n\nfunction _getStandardContentBlockConverter(\n  isMultimodalModel: boolean\n): StandardContentBlockConverter<{\n  text: TextPart;\n  image: FileDataPart | InlineDataPart;\n  audio: FileDataPart | InlineDataPart;\n  file: FileDataPart | InlineDataPart | TextPart;\n}> {\n  const standardContentBlockConverter: StandardContentBlockConverter<{\n    text: TextPart;\n    image: FileDataPart | InlineDataPart;\n    audio: FileDataPart | InlineDataPart;\n    file: FileDataPart | InlineDataPart | TextPart;\n  }> = {\n    providerName: 'Google Gemini',\n\n    fromStandardTextBlock(block) {\n      return {\n        text: block.text,\n      };\n    },\n\n    fromStandardImageBlock(block): FileDataPart | InlineDataPart {\n      if (!isMultimodalModel) {\n        throw new Error('This model does not support images');\n      }\n      if (block.source_type === 'url') {\n        const data = parseBase64DataUrl({ dataUrl: block.url });\n        if (data) {\n          return {\n            inlineData: {\n              mimeType: data.mime_type,\n              data: data.data,\n            },\n          };\n        } else {\n          return {\n            fileData: {\n              mimeType: block.mime_type ?? '',\n              fileUri: block.url,\n            },\n          };\n        }\n      }\n\n      if (block.source_type === 'base64') {\n        return {\n          inlineData: {\n            mimeType: block.mime_type ?? '',\n            data: block.data,\n          },\n        };\n      }\n\n      throw new Error(`Unsupported source type: ${block.source_type}`);\n    },\n\n    fromStandardAudioBlock(block): FileDataPart | InlineDataPart {\n      if (!isMultimodalModel) {\n        throw new Error('This model does not support audio');\n      }\n      if (block.source_type === 'url') {\n        const data = parseBase64DataUrl({ dataUrl: block.url });\n        if (data) {\n          return {\n            inlineData: {\n              mimeType: data.mime_type,\n              data: data.data,\n            },\n          };\n        } else {\n          return {\n            fileData: {\n              mimeType: block.mime_type ?? '',\n              fileUri: block.url,\n            },\n          };\n        }\n      }\n\n      if (block.source_type === 'base64') {\n        return {\n          inlineData: {\n            mimeType: block.mime_type ?? '',\n            data: block.data,\n          },\n        };\n      }\n\n      throw new Error(`Unsupported source type: ${block.source_type}`);\n    },\n\n    fromStandardFileBlock(block): FileDataPart | InlineDataPart | TextPart {\n      if (!isMultimodalModel) {\n        throw new Error('This model does not support files');\n      }\n      if (block.source_type === 'text') {\n        return {\n          text: block.text,\n        };\n      }\n      if (block.source_type === 'url') {\n        const data = parseBase64DataUrl({ dataUrl: block.url });\n        if (data) {\n          return {\n            inlineData: {\n              mimeType: data.mime_type,\n              data: data.data,\n            },\n          };\n        } else {\n          return {\n            fileData: {\n              mimeType: block.mime_type ?? '',\n              fileUri: block.url,\n            },\n          };\n        }\n      }\n\n      if (block.source_type === 'base64') {\n        return {\n          inlineData: {\n            mimeType: block.mime_type ?? '',\n            data: block.data,\n          },\n        };\n      }\n      throw new Error(`Unsupported source type: ${block.source_type}`);\n    },\n  };\n  return standardContentBlockConverter;\n}\n\nfunction _convertLangChainContentToPart(\n  content: MessageContentComplex,\n  isMultimodalModel: boolean\n): Part | undefined {\n  if (isDataContentBlock(content)) {\n    return convertToProviderContentBlock(\n      content,\n      _getStandardContentBlockConverter(isMultimodalModel)\n    );\n  }\n\n  if (content.type === 'text') {\n    return { text: content.text };\n  } else if (content.type === 'executableCode') {\n    return { executableCode: content.executableCode };\n  } else if (content.type === 'codeExecutionResult') {\n    return { codeExecutionResult: content.codeExecutionResult };\n  } else if (content.type === 'image_url') {\n    if (!isMultimodalModel) {\n      throw new Error('This model does not support images');\n    }\n    let source: string;\n    if (typeof content.image_url === 'string') {\n      source = content.image_url;\n    } else if (\n      typeof content.image_url === 'object' &&\n      'url' in content.image_url\n    ) {\n      source = content.image_url.url;\n    } else {\n      throw new Error('Please provide image as base64 encoded data URL');\n    }\n    const [dm, data] = source.split(',');\n    if (!dm.startsWith('data:')) {\n      throw new Error('Please provide image as base64 encoded data URL');\n    }\n\n    const [mimeType, encoding] = dm.replace(/^data:/, '').split(';');\n    if (encoding !== 'base64') {\n      throw new Error('Please provide image as base64 encoded data URL');\n    }\n\n    return {\n      inlineData: {\n        data,\n        mimeType,\n      },\n    };\n  } else if (content.type === 'media') {\n    return messageContentMedia(content);\n  } else if (content.type === 'tool_use') {\n    return {\n      functionCall: {\n        name: content.name,\n        args: content.input,\n      },\n    };\n  } else if (\n    content.type?.includes('/') === true &&\n    // Ensure it's a single slash.\n    content.type.split('/').length === 2 &&\n    'data' in content &&\n    typeof content.data === 'string'\n  ) {\n    return {\n      inlineData: {\n        mimeType: content.type,\n        data: content.data,\n      },\n    };\n  } else if ('functionCall' in content) {\n    // No action needed here â€” function calls will be added later from message.tool_calls\n    return undefined;\n  } else {\n    if ('type' in content) {\n      throw new Error(`Unknown content type ${content.type}`);\n    } else {\n      throw new Error(`Unknown content ${JSON.stringify(content)}`);\n    }\n  }\n}\n\nexport function convertMessageContentToParts(\n  message: BaseMessage,\n  isMultimodalModel: boolean,\n  previousMessages: BaseMessage[],\n  model?: string\n): Part[] {\n  if (isToolMessage(message)) {\n    const messageName =\n      message.name ??\n      inferToolNameFromPreviousMessages(message, previousMessages);\n    if (messageName === undefined) {\n      throw new Error(\n        `Google requires a tool name for each tool call response, and we could not infer a called tool name for ToolMessage \"${message.id}\" from your passed messages. Please populate a \"name\" field on that ToolMessage explicitly.`\n      );\n    }\n\n    const result = Array.isArray(message.content)\n      ? (message.content\n        .map((c) => _convertLangChainContentToPart(c, isMultimodalModel))\n        .filter((p) => p !== undefined) as Part[])\n      : message.content;\n\n    if (message.status === 'error') {\n      return [\n        {\n          functionResponse: {\n            name: messageName,\n            // The API expects an object with an `error` field if the function call fails.\n            // `error` must be a valid object (not a string or array), so we wrap `message.content` here\n            response: { error: { details: result } },\n          },\n        },\n      ];\n    }\n\n    return [\n      {\n        functionResponse: {\n          name: messageName,\n          // again, can't have a string or array value for `response`, so we wrap it as an object here\n          response: { result },\n        },\n      },\n    ];\n  }\n\n  let functionCalls: FunctionCallPart[] = [];\n  const messageParts: Part[] = [];\n\n  if (typeof message.content === 'string' && message.content) {\n    messageParts.push({ text: message.content });\n  }\n\n  if (Array.isArray(message.content)) {\n    messageParts.push(\n      ...(message.content\n        .map((c) => _convertLangChainContentToPart(c, isMultimodalModel))\n        .filter((p) => p !== undefined) as Part[])\n    );\n  }\n\n  const functionThoughtSignatures = (\n    message.additional_kwargs as BaseMessage['additional_kwargs'] | undefined\n  )?.[_FUNCTION_CALL_THOUGHT_SIGNATURES_MAP_KEY] as\n    | Record<string, string>\n    | undefined;\n\n  if (isAIMessage(message) && (message.tool_calls?.length ?? 0) > 0) {\n    functionCalls = (message.tool_calls ?? []).map((tc) => {\n      const thoughtSignature = iife(() => {\n        if (tc.id != null && tc.id !== '') {\n          const signature = functionThoughtSignatures?.[tc.id];\n          if (signature != null && signature !== '') {\n            return signature;\n          }\n        }\n        if (model?.includes('gemini-3') === true) {\n          return DUMMY_SIGNATURE;\n        }\n        return '';\n      });\n\n      return {\n        functionCall: {\n          name: tc.name,\n          args: tc.args,\n        },\n        ...(thoughtSignature ? { thoughtSignature } : {}),\n      };\n    });\n  }\n\n  return [...messageParts, ...functionCalls];\n}\n\nexport function convertBaseMessagesToContent(\n  messages: BaseMessage[],\n  isMultimodalModel: boolean,\n  convertSystemMessageToHumanContent: boolean = false,\n\n  model?: string\n): Content[] | undefined {\n  return messages.reduce<{\n    content: Content[] | undefined;\n    mergeWithPreviousContent: boolean;\n  }>(\n    (acc, message, index) => {\n      if (!isBaseMessage(message)) {\n        throw new Error('Unsupported message input');\n      }\n      const author = getMessageAuthor(message);\n      if (author === 'system' && index !== 0) {\n        throw new Error('System message should be the first one');\n      }\n      const role = convertAuthorToRole(author);\n\n      const prevContent = acc.content?.[acc.content.length];\n      if (\n        !acc.mergeWithPreviousContent &&\n        prevContent &&\n        prevContent.role === role\n      ) {\n        throw new Error(\n          'Google Generative AI requires alternate messages between authors'\n        );\n      }\n\n      const parts = convertMessageContentToParts(\n        message,\n        isMultimodalModel,\n        messages.slice(0, index),\n        model\n      );\n\n      if (acc.mergeWithPreviousContent) {\n        const prevContent = acc.content?.[acc.content.length - 1];\n        if (!prevContent) {\n          throw new Error(\n            'There was a problem parsing your system message. Please try a prompt without one.'\n          );\n        }\n        prevContent.parts.push(...parts);\n\n        return {\n          mergeWithPreviousContent: false,\n          content: acc.content,\n        };\n      }\n      let actualRole = role;\n      if (\n        actualRole === 'function' ||\n        (actualRole === 'system' && !convertSystemMessageToHumanContent)\n      ) {\n        // GenerativeAI API will throw an error if the role is not \"user\" or \"model.\"\n        actualRole = 'user';\n      }\n      const content: Content = {\n        role: actualRole,\n        parts,\n      };\n      return {\n        mergeWithPreviousContent:\n          author === 'system' && !convertSystemMessageToHumanContent,\n        content: [...(acc.content ?? []), content],\n      };\n    },\n    { content: [], mergeWithPreviousContent: false }\n  ).content;\n}\n\nexport function convertResponseContentToChatGenerationChunk(\n  response: EnhancedGenerateContentResponse,\n  extra: {\n    usageMetadata?: UsageMetadata | undefined;\n    index: number;\n  }\n): ChatGenerationChunk | null {\n  if (!response.candidates || response.candidates.length === 0) {\n    return null;\n  }\n  const [candidate] = response.candidates as [\n    Partial<GenerateContentCandidate> | undefined,\n  ];\n  const { content: candidateContent, ...generationInfo } = candidate ?? {};\n\n  // Extract function calls directly from parts to preserve thoughtSignature\n  const functionCalls =\n    (candidateContent?.parts as Part[] | undefined)?.reduce(\n      (acc, p) => {\n        if ('functionCall' in p && p.functionCall) {\n          acc.push({\n            ...p,\n            id:\n              'id' in p.functionCall && typeof p.functionCall.id === 'string'\n                ? p.functionCall.id\n                : uuidv4(),\n          });\n        }\n        return acc;\n      },\n      [] as (\n        | undefined\n        | (FunctionCallPart & { id: string; thoughtSignature?: string })\n      )[]\n    ) ?? [];\n\n  let content: MessageContent | undefined;\n  // Checks if some parts do not have text. If false, it means that the content is a string.\n  const reasoningParts: string[] = [];\n  if (\n    candidateContent != null &&\n    Array.isArray(candidateContent.parts) &&\n    candidateContent.parts.every((p) => 'text' in p)\n  ) {\n    // content = candidateContent.parts.map((p) => p.text).join('');\n    const textParts: string[] = [];\n    for (const part of candidateContent.parts) {\n      if ('thought' in part && part.thought === true) {\n        reasoningParts.push(part.text ?? '');\n        continue;\n      }\n      textParts.push(part.text ?? '');\n    }\n    content = textParts.join('');\n  } else if (candidateContent && Array.isArray(candidateContent.parts)) {\n    content = candidateContent.parts\n      .map((p) => {\n        if ('text' in p && 'thought' in p && p.thought === true) {\n          reasoningParts.push(p.text ?? '');\n          return undefined;\n        } else if ('text' in p) {\n          return {\n            type: 'text',\n            text: p.text,\n          };\n        } else if ('executableCode' in p) {\n          return {\n            type: 'executableCode',\n            executableCode: p.executableCode,\n          };\n        } else if ('codeExecutionResult' in p) {\n          return {\n            type: 'codeExecutionResult',\n            codeExecutionResult: p.codeExecutionResult,\n          };\n        }\n        return p;\n      })\n      .filter((p) => p !== undefined);\n  } else {\n    // no content returned - likely due to abnormal stop reason, e.g. malformed function call\n    content = [];\n  }\n\n  let text = '';\n  if (typeof content === 'string' && content) {\n    text = content;\n  } else if (Array.isArray(content)) {\n    const block = content.find((b) => 'text' in b) as\n      | { text: string }\n      | undefined;\n    text = block?.text ?? '';\n  }\n\n  const toolCallChunks: ToolCallChunk[] = [];\n  if (functionCalls.length > 0) {\n    toolCallChunks.push(\n      ...functionCalls.map((fc) => ({\n        type: 'tool_call_chunk' as const,\n        id: fc?.id,\n        name: fc?.functionCall.name,\n        args: JSON.stringify(fc?.functionCall.args),\n      }))\n    );\n  }\n\n  // Extract thought signatures from function calls for Gemini 3+\n  const functionThoughtSignatures = functionCalls.reduce(\n    (acc, fc) => {\n      if (\n        fc &&\n        'thoughtSignature' in fc &&\n        typeof fc.thoughtSignature === 'string'\n      ) {\n        acc[fc.id] = fc.thoughtSignature;\n      }\n      return acc;\n    },\n    {} as Record<string, string>\n  );\n\n  const additional_kwargs: ChatGeneration['message']['additional_kwargs'] = {\n    [_FUNCTION_CALL_THOUGHT_SIGNATURES_MAP_KEY]: functionThoughtSignatures,\n  };\n\n  if (reasoningParts.length > 0) {\n    additional_kwargs.reasoning = reasoningParts.join('');\n  }\n\n  if (candidate?.groundingMetadata) {\n    additional_kwargs.groundingMetadata = candidate.groundingMetadata;\n  }\n\n  const isFinalChunk =\n    response.candidates[0]?.finishReason === 'STOP' ||\n    response.candidates[0]?.finishReason === 'MAX_TOKENS' ||\n    response.candidates[0]?.finishReason === 'SAFETY';\n\n  return new ChatGenerationChunk({\n    text,\n    message: new AIMessageChunk({\n      content: content,\n      name: !candidateContent ? undefined : candidateContent.role,\n      tool_call_chunks: toolCallChunks,\n      // Each chunk can have unique \"generationInfo\", and merging strategy is unclear,\n      // so leave blank for now.\n      additional_kwargs,\n      usage_metadata: isFinalChunk ? extra.usageMetadata : undefined,\n    }),\n    generationInfo,\n  });\n}\n\n/**\n * Maps a Google GenerateContentResult to a LangChain ChatResult\n */\nexport function mapGenerateContentResultToChatResult(\n  response: EnhancedGenerateContentResponse,\n  extra?: {\n    usageMetadata: UsageMetadata | undefined;\n  }\n): ChatResult {\n  if (\n    !response.candidates ||\n    response.candidates.length === 0 ||\n    !response.candidates[0]\n  ) {\n    return {\n      generations: [],\n      llmOutput: {\n        filters: response.promptFeedback,\n      },\n    };\n  }\n  const [candidate] = response.candidates as [\n    Partial<GenerateContentCandidate> | undefined,\n  ];\n  const { content: candidateContent, ...generationInfo } = candidate ?? {};\n\n  // Extract function calls directly from parts to preserve thoughtSignature\n  const functionCalls =\n    candidateContent?.parts.reduce(\n      (acc, p) => {\n        if ('functionCall' in p && p.functionCall) {\n          acc.push({\n            ...p,\n            id:\n              'id' in p.functionCall && typeof p.functionCall.id === 'string'\n                ? p.functionCall.id\n                : uuidv4(),\n          });\n        }\n        return acc;\n      },\n      [] as (FunctionCallPart & { id: string; thoughtSignature?: string })[]\n    ) ?? [];\n\n  let content: MessageContent | undefined;\n  const reasoningParts: string[] = [];\n  if (\n    Array.isArray(candidateContent?.parts) &&\n    candidateContent.parts.length === 1 &&\n    candidateContent.parts[0].text &&\n    !(\n      'thought' in candidateContent.parts[0] &&\n      candidateContent.parts[0].thought === true\n    )\n  ) {\n    content = candidateContent.parts[0].text;\n  } else if (\n    Array.isArray(candidateContent?.parts) &&\n    candidateContent.parts.length > 0\n  ) {\n    content = candidateContent.parts\n      .map((p) => {\n        if ('text' in p && 'thought' in p && p.thought === true) {\n          reasoningParts.push(p.text ?? '');\n          return undefined;\n        } else if ('text' in p) {\n          return {\n            type: 'text',\n            text: p.text,\n          };\n        } else if ('executableCode' in p) {\n          return {\n            type: 'executableCode',\n            executableCode: p.executableCode,\n          };\n        } else if ('codeExecutionResult' in p) {\n          return {\n            type: 'codeExecutionResult',\n            codeExecutionResult: p.codeExecutionResult,\n          };\n        }\n        return p;\n      })\n      .filter((p) => p !== undefined);\n  } else {\n    content = [];\n  }\n  let text = '';\n  if (typeof content === 'string') {\n    text = content;\n  } else if (Array.isArray(content) && content.length > 0) {\n    const block = content.find((b) => 'text' in b) as\n      | { text: string }\n      | undefined;\n    text = block?.text ?? text;\n  }\n\n  const additional_kwargs: ChatGeneration['message']['additional_kwargs'] = {\n    ...generationInfo,\n  };\n  if (reasoningParts.length > 0) {\n    additional_kwargs.reasoning = reasoningParts.join('');\n  }\n\n  // Extract thought signatures from function calls for Gemini 3+\n  const functionThoughtSignatures = functionCalls.reduce(\n    (acc, fc) => {\n      if ('thoughtSignature' in fc && typeof fc.thoughtSignature === 'string') {\n        acc[fc.id] = fc.thoughtSignature;\n      }\n      return acc;\n    },\n    {} as Record<string, string>\n  );\n\n  const tool_calls = functionCalls.map((fc) => ({\n    type: 'tool_call' as const,\n    id: fc.id,\n    name: fc.functionCall.name,\n    args: fc.functionCall.args,\n  }));\n\n  // Store thought signatures map for later retrieval\n  additional_kwargs[_FUNCTION_CALL_THOUGHT_SIGNATURES_MAP_KEY] =\n    functionThoughtSignatures;\n\n  const generation: ChatGeneration = {\n    text,\n    message: new AIMessage({\n      content: content ?? '',\n      tool_calls,\n      additional_kwargs,\n      usage_metadata: extra?.usageMetadata,\n    }),\n    generationInfo,\n  };\n  return {\n    generations: [generation],\n    llmOutput: {\n      tokenUsage: {\n        promptTokens: extra?.usageMetadata?.input_tokens,\n        completionTokens: extra?.usageMetadata?.output_tokens,\n        totalTokens: extra?.usageMetadata?.total_tokens,\n      },\n    },\n  };\n}\n\nexport function convertToGenerativeAITools(\n  tools: GoogleGenerativeAIToolType[]\n): GoogleGenerativeAIFunctionDeclarationsTool[] {\n  if (\n    tools.every(\n      (tool) =>\n        'functionDeclarations' in tool &&\n        Array.isArray(tool.functionDeclarations)\n    )\n  ) {\n    return tools as GoogleGenerativeAIFunctionDeclarationsTool[];\n  }\n  return [\n    {\n      functionDeclarations: tools.map(\n        (tool): GenerativeAIFunctionDeclaration => {\n          if (isLangChainTool(tool)) {\n            const jsonSchema = schemaToGenerativeAIParameters(tool.schema);\n            if (\n              jsonSchema.type === 'object' &&\n              'properties' in jsonSchema &&\n              Object.keys(jsonSchema.properties).length === 0\n            ) {\n              return {\n                name: tool.name,\n                description: tool.description,\n              };\n            }\n            return {\n              name: tool.name,\n              description: tool.description,\n              parameters: jsonSchema,\n            };\n          }\n          if (isOpenAITool(tool)) {\n            return {\n              name: tool.function.name,\n              description:\n                tool.function.description ?? 'A function available to call.',\n              parameters: jsonSchemaToGeminiParameters(\n                tool.function.parameters\n              ),\n            };\n          }\n          return tool as unknown as GenerativeAIFunctionDeclaration;\n        }\n      ),\n    },\n  ];\n}\n"],"names":["ChatMessage","isAIMessage","parseBase64DataUrl","isDataContentBlock","convertToProviderContentBlock","isToolMessage","messages","isBaseMessage","uuidv4","ChatGenerationChunk","AIMessageChunk","AIMessage"],"mappings":"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"}