{"version":3,"file":"run.cjs","sources":["../../src/run.ts"],"sourcesContent":["// src/run.ts\nimport './instrumentation';\nimport { CallbackHandler } from '@langfuse/langchain';\nimport { PromptTemplate } from '@langchain/core/prompts';\nimport { RunnableLambda } from '@langchain/core/runnables';\nimport { AzureChatOpenAI, ChatOpenAI } from '@langchain/openai';\nimport type {\n  MessageContentComplex,\n  BaseMessage,\n} from '@langchain/core/messages';\nimport type { StringPromptValue } from '@langchain/core/prompt_values';\nimport type { RunnableConfig } from '@langchain/core/runnables';\nimport type * as t from '@/types';\nimport {\n  createCompletionTitleRunnable,\n  createTitleRunnable,\n} from '@/utils/title';\nimport { GraphEvents, Callback, TitleMethod } from '@/common';\nimport { MultiAgentGraph } from '@/graphs/MultiAgentGraph';\nimport { createTokenCounter } from '@/utils/tokens';\nimport { StandardGraph } from '@/graphs/Graph';\nimport { HandlerRegistry } from '@/events';\nimport { isOpenAILike } from '@/utils/llm';\nimport { isPresent } from '@/utils/misc';\n\nexport const defaultOmitOptions = new Set([\n  'stream',\n  'thinking',\n  'streaming',\n  'maxTokens',\n  'clientOptions',\n  'thinkingConfig',\n  'thinkingBudget',\n  'includeThoughts',\n  'maxOutputTokens',\n  'additionalModelRequestFields',\n]);\n\nexport class Run<_T extends t.BaseGraphState> {\n  id: string;\n  private tokenCounter?: t.TokenCounter;\n  private handlerRegistry?: HandlerRegistry;\n  private indexTokenCountMap?: Record<string, number>;\n  graphRunnable?: t.CompiledStateWorkflow;\n  Graph: StandardGraph | MultiAgentGraph | undefined;\n  returnContent: boolean = false;\n\n  private constructor(config: Partial<t.RunConfig>) {\n    const runId = config.runId ?? '';\n    if (!runId) {\n      throw new Error('Run ID not provided');\n    }\n\n    this.id = runId;\n    this.tokenCounter = config.tokenCounter;\n    this.indexTokenCountMap = config.indexTokenCountMap;\n\n    const handlerRegistry = new HandlerRegistry();\n\n    if (config.customHandlers) {\n      for (const [eventType, handler] of Object.entries(\n        config.customHandlers\n      )) {\n        handlerRegistry.register(eventType, handler);\n      }\n    }\n\n    this.handlerRegistry = handlerRegistry;\n\n    if (!config.graphConfig) {\n      throw new Error('Graph config not provided');\n    }\n\n    /** Handle different graph types */\n    if (config.graphConfig.type === 'multi-agent') {\n      this.graphRunnable = this.createMultiAgentGraph(config.graphConfig);\n      if (this.Graph) {\n        this.Graph.handlerRegistry = handlerRegistry;\n      }\n    } else {\n      /** Default to legacy graph for 'standard' or undefined type */\n      this.graphRunnable = this.createLegacyGraph(config.graphConfig);\n      if (this.Graph) {\n        this.Graph.compileOptions =\n          config.graphConfig.compileOptions ?? this.Graph.compileOptions;\n        this.Graph.handlerRegistry = handlerRegistry;\n      }\n    }\n\n    this.returnContent = config.returnContent ?? false;\n  }\n\n  private createLegacyGraph(\n    config: t.LegacyGraphConfig | t.StandardGraphConfig\n  ): t.CompiledStateWorkflow {\n    let agentConfig: t.AgentInputs;\n    let signal: AbortSignal | undefined;\n\n    /** Check if this is a multi-agent style config (has agents array) */\n    if ('agents' in config && Array.isArray(config.agents)) {\n      if (config.agents.length === 0) {\n        throw new Error('At least one agent must be provided');\n      }\n      agentConfig = config.agents[0];\n      signal = config.signal;\n    } else {\n      /** Legacy path: build agent config from llmConfig */\n      const {\n        type: _type,\n        llmConfig,\n        signal: legacySignal,\n        tools = [],\n        ...agentInputs\n      } = config as t.LegacyGraphConfig;\n      const { provider, ...clientOptions } = llmConfig;\n\n      agentConfig = {\n        ...agentInputs,\n        tools,\n        provider,\n        clientOptions,\n        agentId: 'default',\n      };\n      signal = legacySignal;\n    }\n\n    const standardGraph = new StandardGraph({\n      signal,\n      runId: this.id,\n      agents: [agentConfig],\n      tokenCounter: this.tokenCounter,\n      indexTokenCountMap: this.indexTokenCountMap,\n    });\n    /** Propagate compile options from graph config */\n    standardGraph.compileOptions = config.compileOptions;\n    this.Graph = standardGraph;\n    return standardGraph.createWorkflow();\n  }\n\n  private createMultiAgentGraph(\n    config: t.MultiAgentGraphConfig\n  ): t.CompiledStateWorkflow {\n    const { agents, edges, compileOptions } = config;\n\n    const multiAgentGraph = new MultiAgentGraph({\n      runId: this.id,\n      agents,\n      edges,\n      tokenCounter: this.tokenCounter,\n      indexTokenCountMap: this.indexTokenCountMap,\n    });\n\n    if (compileOptions != null) {\n      multiAgentGraph.compileOptions = compileOptions;\n    }\n\n    this.Graph = multiAgentGraph;\n    return multiAgentGraph.createWorkflow();\n  }\n\n  static async create<T extends t.BaseGraphState>(\n    config: t.RunConfig\n  ): Promise<Run<T>> {\n    /** Create tokenCounter if indexTokenCountMap is provided but tokenCounter is not */\n    if (config.indexTokenCountMap && !config.tokenCounter) {\n      config.tokenCounter = await createTokenCounter();\n    }\n    return new Run<T>(config);\n  }\n\n  getRunMessages(): BaseMessage[] | undefined {\n    if (!this.Graph) {\n      throw new Error(\n        'Graph not initialized. Make sure to use Run.create() to instantiate the Run.'\n      );\n    }\n    return this.Graph.getRunMessages();\n  }\n\n  /**\n   * Creates a custom event callback handler that intercepts custom events\n   * and processes them through our handler registry instead of EventStreamCallbackHandler\n   */\n  private createCustomEventCallback() {\n    return async (\n      eventName: string,\n      data: unknown,\n      runId: string,\n      tags?: string[],\n      metadata?: Record<string, unknown>\n    ): Promise<void> => {\n      if (\n        (data as t.StreamEventData)['emitted'] === true &&\n        eventName === GraphEvents.CHAT_MODEL_STREAM\n      ) {\n        return;\n      }\n      const handler = this.handlerRegistry?.getHandler(eventName);\n      if (handler && this.Graph) {\n        return await handler.handle(\n          eventName,\n          data as\n            | t.StreamEventData\n            | t.ModelEndData\n            | t.RunStep\n            | t.RunStepDeltaEvent\n            | t.MessageDeltaEvent\n            | t.ReasoningDeltaEvent\n            | { result: t.ToolEndEvent },\n          metadata,\n          this.Graph\n        );\n      }\n    };\n  }\n\n  async processStream(\n    inputs: t.IState,\n    config: Partial<RunnableConfig> & { version: 'v1' | 'v2'; run_id?: string },\n    streamOptions?: t.EventStreamOptions\n  ): Promise<MessageContentComplex[] | undefined> {\n    if (this.graphRunnable == null) {\n      throw new Error(\n        'Run not initialized. Make sure to use Run.create() to instantiate the Run.'\n      );\n    }\n    if (!this.Graph) {\n      throw new Error(\n        'Graph not initialized. Make sure to use Run.create() to instantiate the Run.'\n      );\n    }\n\n    this.Graph.resetValues(streamOptions?.keepContent);\n\n    /** Custom event callback to intercept and handle custom events */\n    const customEventCallback = this.createCustomEventCallback();\n\n    const baseCallbacks = (config.callbacks as t.ProvidedCallbacks) ?? [];\n    const streamCallbacks = streamOptions?.callbacks\n      ? this.getCallbacks(streamOptions.callbacks)\n      : [];\n\n    config.callbacks = baseCallbacks.concat(streamCallbacks).concat({\n      [Callback.CUSTOM_EVENT]: customEventCallback,\n    });\n\n    if (\n      isPresent(process.env.LANGFUSE_SECRET_KEY) &&\n      isPresent(process.env.LANGFUSE_PUBLIC_KEY) &&\n      isPresent(process.env.LANGFUSE_BASE_URL)\n    ) {\n      const userId = config.configurable?.user_id;\n      const sessionId = config.configurable?.thread_id;\n      const traceMetadata = {\n        messageId: this.id,\n        parentMessageId: config.configurable?.requestBody?.parentMessageId,\n      };\n      const handler = new CallbackHandler({\n        userId,\n        sessionId,\n        traceMetadata,\n      });\n      config.callbacks = (\n        (config.callbacks as t.ProvidedCallbacks) ?? []\n      ).concat([handler]);\n    }\n\n    if (!this.id) {\n      throw new Error('Run ID not provided');\n    }\n\n    config.run_id = this.id;\n    config.configurable = Object.assign(config.configurable ?? {}, {\n      run_id: this.id,\n    });\n\n    const stream = this.graphRunnable.streamEvents(inputs, config, {\n      raiseError: true,\n      /**\n       * Prevent EventStreamCallbackHandler from processing custom events.\n       * Custom events are already handled via our createCustomEventCallback()\n       * which routes them through the handlerRegistry.\n       * Without this flag, EventStreamCallbackHandler throws errors when\n       * custom events are dispatched for run IDs not in its internal map\n       * (due to timing issues in parallel execution or after run cleanup).\n       */\n      ignoreCustomEvent: true,\n    });\n\n    for await (const event of stream) {\n      const { data, metadata, ...info } = event;\n\n      const eventName: t.EventName = info.event;\n\n      /** Skip custom events as they're handled by our callback */\n      if (eventName === GraphEvents.ON_CUSTOM_EVENT) {\n        continue;\n      }\n\n      const handler = this.handlerRegistry?.getHandler(eventName);\n      if (handler) {\n        await handler.handle(eventName, data, metadata, this.Graph);\n      }\n    }\n\n    if (this.returnContent) {\n      return this.Graph.getContentParts();\n    }\n  }\n\n  private createSystemCallback<K extends keyof t.ClientCallbacks>(\n    clientCallbacks: t.ClientCallbacks,\n    key: K\n  ): t.SystemCallbacks[K] {\n    return ((...args: unknown[]) => {\n      const clientCallback = clientCallbacks[key];\n      if (clientCallback && this.Graph) {\n        (clientCallback as (...args: unknown[]) => void)(this.Graph, ...args);\n      }\n    }) as t.SystemCallbacks[K];\n  }\n\n  getCallbacks(clientCallbacks: t.ClientCallbacks): t.SystemCallbacks {\n    return {\n      [Callback.TOOL_ERROR]: this.createSystemCallback(\n        clientCallbacks,\n        Callback.TOOL_ERROR\n      ),\n      [Callback.TOOL_START]: this.createSystemCallback(\n        clientCallbacks,\n        Callback.TOOL_START\n      ),\n      [Callback.TOOL_END]: this.createSystemCallback(\n        clientCallbacks,\n        Callback.TOOL_END\n      ),\n    };\n  }\n\n  async generateTitle({\n    provider,\n    inputText,\n    contentParts,\n    titlePrompt,\n    clientOptions,\n    chainOptions,\n    skipLanguage,\n    titleMethod = TitleMethod.COMPLETION,\n    titlePromptTemplate,\n  }: t.RunTitleOptions): Promise<{ language?: string; title?: string }> {\n    if (\n      chainOptions != null &&\n      isPresent(process.env.LANGFUSE_SECRET_KEY) &&\n      isPresent(process.env.LANGFUSE_PUBLIC_KEY) &&\n      isPresent(process.env.LANGFUSE_BASE_URL)\n    ) {\n      const userId = chainOptions.configurable?.user_id;\n      const sessionId = chainOptions.configurable?.thread_id;\n      const traceMetadata = {\n        messageId: 'title-' + this.id,\n      };\n      const handler = new CallbackHandler({\n        userId,\n        sessionId,\n        traceMetadata,\n      });\n      chainOptions.callbacks = (\n        (chainOptions.callbacks as t.ProvidedCallbacks) ?? []\n      ).concat([handler]);\n    }\n\n    const convoTemplate = PromptTemplate.fromTemplate(\n      titlePromptTemplate ?? 'User: {input}\\nAI: {output}'\n    );\n\n    const response = contentParts\n      .map((part) => {\n        if (part?.type === 'text') return part.text;\n        return '';\n      })\n      .join('\\n');\n\n    const model = this.Graph?.getNewModel({\n      provider,\n      clientOptions,\n    });\n    if (!model) {\n      return { language: '', title: '' };\n    }\n    if (\n      isOpenAILike(provider) &&\n      (model instanceof ChatOpenAI || model instanceof AzureChatOpenAI)\n    ) {\n      model.temperature = (clientOptions as t.OpenAIClientOptions | undefined)\n        ?.temperature as number;\n      model.topP = (clientOptions as t.OpenAIClientOptions | undefined)\n        ?.topP as number;\n      model.frequencyPenalty = (\n        clientOptions as t.OpenAIClientOptions | undefined\n      )?.frequencyPenalty as number;\n      model.presencePenalty = (\n        clientOptions as t.OpenAIClientOptions | undefined\n      )?.presencePenalty as number;\n      model.n = (clientOptions as t.OpenAIClientOptions | undefined)\n        ?.n as number;\n    }\n\n    const convoToTitleInput = new RunnableLambda({\n      func: (\n        promptValue: StringPromptValue\n      ): { convo: string; inputText: string; skipLanguage?: boolean } => ({\n        convo: promptValue.value,\n        inputText,\n        skipLanguage,\n      }),\n    }).withConfig({ runName: 'ConvoTransform' });\n\n    const titleChain =\n      titleMethod === TitleMethod.COMPLETION\n        ? await createCompletionTitleRunnable(model, titlePrompt)\n        : await createTitleRunnable(model, titlePrompt);\n\n    /** Pipes `convoTemplate` -> `transformer` -> `titleChain` */\n    const fullChain = convoTemplate\n      .withConfig({ runName: 'ConvoTemplate' })\n      .pipe(convoToTitleInput)\n      .pipe(titleChain)\n      .withConfig({ runName: 'TitleChain' });\n\n    const invokeConfig = Object.assign({}, chainOptions, {\n      run_id: this.id,\n      runId: this.id,\n    });\n\n    try {\n      return await fullChain.invoke(\n        { input: inputText, output: response },\n        invokeConfig\n      );\n    } catch (_e) {\n      // Fallback: strip callbacks to avoid EventStream tracer errors in certain environments\n      // But preserve langfuse handler if it exists\n      const langfuseHandler = (\n        invokeConfig.callbacks as t.ProvidedCallbacks\n      )?.find((cb) => cb instanceof CallbackHandler);\n      const { callbacks: _cb, ...rest } = invokeConfig;\n      const safeConfig = Object.assign({}, rest, {\n        callbacks: langfuseHandler ? [langfuseHandler] : [],\n      });\n      return await fullChain.invoke(\n        { input: inputText, output: response },\n        safeConfig as Partial<RunnableConfig>\n      );\n    }\n  }\n}\n"],"names":["HandlerRegistry","StandardGraph","MultiAgentGraph","createTokenCounter","GraphEvents","Callback","isPresent","CallbackHandler","TitleMethod","PromptTemplate","isOpenAILike","ChatOpenAI","AzureChatOpenAI","RunnableLambda","createCompletionTitleRunnable","createTitleRunnable"],"mappings":"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"}